FROM python:3.10-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    nginx \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements
COPY requirements.txt .

# Install Python dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Create data directory
RUN mkdir -p /app/data

# Configure nginx
RUN echo 'server { listen 8080; root /app; location / { try_files /live_dashboard.html =404; } location /dashboard_data.json { alias /app/data/dashboard_data.json; add_header Cache-Control "no-cache"; } }' > /etc/nginx/sites-available/default

EXPOSE 8080

# Startup script
RUN echo '#!/bin/bash' > /app/start.sh && \
    echo 'set -e' >> /app/start.sh && \
    echo 'echo "Initializing database..."' >> /app/start.sh && \
    echo 'python init_database.py' >> /app/start.sh && \
    echo 'echo "Bootstrapping data..."' >> /app/start.sh && \
    echo 'python bootstrap_data.py' >> /app/start.sh && \
    echo 'echo "Starting dashboard updater..."' >> /app/start.sh && \
    echo 'python -u update_dashboard_data.py &' >> /app/start.sh && \
    echo 'sleep 3' >> /app/start.sh && \
    echo 'echo "Starting agent..."' >> /app/start.sh && \
    echo 'python -u start_agent.py &' >> /app/start.sh && \
    echo 'sleep 2' >> /app/start.sh && \
    echo 'echo "Starting nginx..."' >> /app/start.sh && \
    echo 'nginx -g "daemon off;"' >> /app/start.sh && \
    chmod +x /app/start.sh

CMD ["/app/start.sh"]
